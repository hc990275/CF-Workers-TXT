<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloudflare Workers Editor (Mock Mode)</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
  body { font-family: 'Segoe UI', system-ui, sans-serif; }
  #editor { font-family: 'Fira Code', 'Consolas', monospace; tab-size: 2; }
  #preview { line-height: 1.8; }
  #preview h1 { font-size: 1.8em; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 0.3em; margin: 1em 0 0.5em; }
  #preview h2 { font-size: 1.5em; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 0.2em; margin: 1em 0 0.5em; }
  #preview h3 { font-size: 1.25em; font-weight: bold; margin: 1em 0 0.5em; }
  #preview p { margin: 0.8em 0; }
  #preview code { background: #1e293b; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
  #preview pre { background: #0f172a; padding: 1em; border-radius: 8px; overflow-x: auto; margin: 1em 0; }
  #preview pre code { background: none; padding: 0; }
  #preview ul, #preview ol { padding-left: 1.5em; margin: 0.5em 0; }
  #preview li { margin: 0.3em 0; }
  #preview blockquote { border-left: 4px solid #3b82f6; padding-left: 1em; margin: 1em 0; color: #94a3b8; }
  #preview a { color: #60a5fa; text-decoration: underline; }
  #preview table { border-collapse: collapse; margin: 1em 0; }
  #preview th, #preview td { border: 1px solid #475569; padding: 8px 12px; }
  #preview th { background: #334155; }
  .tree-item { cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.15s; }
  .tree-item:hover { background: #334155; }
  .tree-item.active { background: #3b82f6; color: white; }
  .toast { animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #1e293b; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal.show { display: flex; }
</style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden">

<!-- Token è®¤è¯å¼¹çª— -->
<div id="authModal" class="modal show">
  <div class="bg-slate-800 rounded-2xl p-8 w-full max-w-md shadow-2xl border border-slate-700">
    <div class="text-center mb-6">
      <div class="text-5xl mb-3">ğŸ”</div>
      <h2 class="text-2xl font-bold">èº«ä»½éªŒè¯</h2>
      <p class="text-slate-400 mt-2">è¯·è¾“å…¥è®¿é—®ä»¤ç‰Œ (æµ‹è¯•æ¨¡å¼)</p>
      <p class="text-xs text-slate-500 mt-1">æç¤º: è¾“å…¥ <code class="bg-slate-900 px-1 rounded">admin</code> è·å–å®Œæ•´æƒé™</p>
    </div>
    <input id="tokenInput" type="password" placeholder="è¾“å…¥ Token..." 
      class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-center text-lg">
    <div class="flex gap-3 mb-4">
      <button id="authBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-semibold transition">
        ğŸ”‘ éªŒè¯ç™»å½•
      </button>
      <button id="guestBtn" class="flex-1 bg-slate-600 hover:bg-slate-500 py-3 rounded-xl font-semibold transition">
        ğŸ‘ï¸ æ¸¸å®¢æµè§ˆ
      </button>
    </div>
    <p id="authError" class="text-red-400 text-center hidden text-sm"></p>
  </div>
</div>

<!-- æ–°å»ºæ–‡ä»¶/ç›®å½•å¼¹çª— -->
<div id="createModal" class="modal">
  <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md shadow-2xl border border-slate-700">
    <h3 class="text-xl font-bold mb-4">æ–°å»º</h3>
    <div class="mb-4">
      <label class="block text-sm mb-2">ç±»å‹</label>
      <div class="flex gap-2">
        <button id="createTypeFile" class="flex-1 py-2 px-4 bg-blue-600 rounded-lg">ğŸ“„ æ–‡ä»¶</button>
        <button id="createTypeDir" class="flex-1 py-2 px-4 bg-slate-600 rounded-lg">ğŸ“ ç›®å½•</button>
      </div>
    </div>
    <div class="mb-4" id="createDirSection">
      <label class="block text-sm mb-2">é€‰æ‹©ç›®å½•</label>
      <select id="createDirSelect" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">æ ¹ç›®å½•</option>
      </select>
    </div>
    <div class="mb-4">
      <label class="block text-sm mb-2"><span id="createPathLabel">æ–‡ä»¶å</span></label>
      <input id="createPath" type="text" placeholder="ä¾‹å¦‚: file.txt" 
        class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <p class="text-xs text-slate-400 mt-1" id="createPathHint">è¯·è¾“å…¥æ–‡ä»¶åï¼ˆåŒ…å«æ‰©å±•åï¼‰</p>
    </div>
    <div class="flex gap-2">
      <button id="createConfirm" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-semibold">
        âœ… åˆ›å»º
      </button>
      <button id="createCancel" class="flex-1 bg-slate-600 hover:bg-slate-500 py-2 rounded-lg">
        âŒ å–æ¶ˆ
      </button>
    </div>
  </div>
</div>

<!-- åˆ†äº«å¼¹çª— -->
<div id="shareModal" class="modal">
  <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-lg shadow-2xl border border-slate-700">
    <h3 class="text-xl font-bold mb-4">ğŸ“¤ åˆ†äº«æ–‡ä»¶</h3>
    <div class="mb-4">
      <label class="block text-sm mb-2">åˆ†äº«é“¾æ¥</label>
      <div class="flex gap-2">
        <input id="shareUrl" type="text" readonly
          class="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-sm">
        <button id="copyShareUrl" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
          ğŸ“‹ å¤åˆ¶
        </button>
      </div>
    </div>
    <div class="mb-4">
      <label class="flex items-center gap-2 cursor-pointer">
        <input id="shareBase64" type="checkbox" class="w-4 h-4 accent-blue-600">
        <span class="text-sm">Base64 åŠ å¯†æ˜¾ç¤º</span>
      </label>
      <p class="text-xs text-slate-400 mt-1">é€‰ä¸­åï¼Œè®¿é—®è€…çœ‹åˆ°çš„æ˜¯ Base64 ç¼–ç åçš„å†…å®¹</p>
    </div>
    <div id="sharePreview" class="mb-4 p-4 bg-slate-900 rounded-lg border border-slate-700 max-h-64 overflow-auto hidden">
      <div class="text-xs text-slate-400 mb-2">é¢„è§ˆ:</div>
      <pre class="text-xs"><code id="sharePreviewContent"></code></pre>
    </div>
    <div class="flex gap-2">
      <button id="shareClose" class="flex-1 bg-slate-600 hover:bg-slate-500 py-2 rounded-lg">
        å…³é—­
      </button>
    </div>
  </div>
</div>

<!-- ä¸»åº”ç”¨ -->
<div id="app" class="flex h-full">
  <!-- ä¾§è¾¹æ  -->
  <div class="w-72 bg-slate-800 border-r border-slate-700 flex flex-col">
    <div class="p-4 border-b border-slate-700">
      <h1 class="text-lg font-bold flex items-center gap-2">
        <span class="text-2xl">ğŸ“</span> åœ¨çº¿ç¼–è¾‘å™¨
      </h1>
      <div class="mt-3 flex items-center justify-between">
        <span id="roleTag" class="text-xs px-2 py-1 rounded-full bg-slate-600">æœªç™»å½•</span>
        <button id="logoutBtn" class="text-xs text-slate-400 hover:text-red-400 transition hidden">é€€å‡º</button>
      </div>
    </div>
    <div class="p-3">
      <input id="search" placeholder="æœç´¢æ–‡ä»¶â€¦" 
        class="w-full px-4 py-2 pl-9 bg-slate-700 border border-slate-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div id="tree" class="flex-1 overflow-y-auto p-2">
      <div class="text-center text-slate-500 py-12">
        <div class="inline-block w-8 h-8 border-2 border-slate-600 border-t-blue-500 rounded-full animate-spin mb-3"></div>
        <div class="text-sm">åŠ è½½ä¸­...</div>
      </div>
    </div>
    <div class="p-3 border-t border-slate-700 space-y-2">
      <button id="createBtn" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm transition hidden">
        â• æ–°å»ºæ–‡ä»¶/ç›®å½•
      </button>
      <button id="refreshBtn" class="w-full bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm transition">
        ğŸ”„ åˆ·æ–°åˆ—è¡¨
      </button>
    </div>
    
    <!-- å‹æƒ…é“¾æ¥ -->
    <div id="friendLinks" class="p-3 border-t border-slate-700 hidden">
      <div class="text-xs text-slate-400 mb-2">ğŸ”— å‹æƒ…é“¾æ¥</div>
      <div id="friendLinksList" class="space-y-1"></div>
    </div>
  </div>

  <!-- ç¼–è¾‘åŒº -->
  <div class="flex-1 flex flex-col bg-slate-900">
    <div class="h-14 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-4">
      <div class="flex items-center gap-3">
        <span id="filepath" class="text-slate-400 font-mono text-sm">æœªé€‰æ‹©æ–‡ä»¶</span>
        <span id="fileStatus" class="text-xs px-2 py-0.5 rounded-full hidden"></span>
      </div>
      <div class="flex items-center gap-2">
        <button id="shareBtn" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition hidden">
          ğŸ“¤ åˆ†äº«
        </button>
        <button id="deleteBtn" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition hidden">
          ğŸ—‘ï¸ åˆ é™¤
        </button>
        <button id="previewToggle" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition hidden">
          ğŸ‘ï¸ é¢„è§ˆ
        </button>
        <button id="saveBtn" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-semibold transition disabled:opacity-40" disabled>
          ğŸ’¾ ä¿å­˜
        </button>
      </div>
    </div>
    <div id="panes" class="flex-1 flex overflow-hidden">
      <div id="welcome" class="flex-1 flex items-center justify-center">
        <div class="text-center">
          <div class="text-7xl mb-6">ğŸ“„</div>
          <h2 class="text-2xl font-bold mb-3">æ¬¢è¿ä½¿ç”¨åœ¨çº¿ç¼–è¾‘å™¨</h2>
          <p class="text-slate-400">ä»å·¦ä¾§é€‰æ‹©æ–‡ä»¶å¼€å§‹ç¼–è¾‘</p>
          <div class="mt-4 text-xs text-slate-600 p-2 border border-slate-700 rounded inline-block">
             MOCK æ¨¡å¼å·²å¯ç”¨: æ‰€æœ‰æ“ä½œä»…åœ¨æœ¬åœ°ç”Ÿæ•ˆ
          </div>
        </div>
      </div>
      <textarea id="editor" class="hidden flex-1 bg-slate-950 text-slate-100 p-4 resize-none focus:outline-none text-sm leading-relaxed" spellcheck="false"></textarea>
      <div id="preview" class="hidden w-1/2 bg-slate-850 p-6 overflow-y-auto border-l border-slate-700"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toasts" class="fixed top-4 right-4 space-y-2 z-50"></div>

<script>
// ==========================================
// MOCK API LAYER - Simulates Backend
// ==========================================
const MockBackend = (() => {
  // Initial Data
  let fileSystem = {
    'README.md': '# Hello World\nThis is a mocked file system.\n\n- Feature 1\n- Feature 2',
    'config.json': '{\n  "site": "My Awesome Site",\n  "version": "1.0.0"\n}',
    'src/main.js': 'console.log("Hello from source");',
    'share/1.txt': 'This is a text file in a subdirectory.',
    'share/2.txt': 'Another shared file here.\nLine 2\nLine 3',
    'docs/guide.md': '# User Guide\n\n1. Login\n2. Edit\n3. Save',
  };
  
  const friendLinks = [
    { name: "GitHub", url: "https://github.com" },
    { name: "Cloudflare", url: "https://cloudflare.com" },
    { name: "Tailwind CSS", url: "https://tailwindcss.com" }
  ];

  const delay = ms => new Promise(r => setTimeout(r, ms));

  return {
    async fetch(url, options = {}) {
      await delay(300); // Simulate network latency
      const u = new URL(url, window.location.origin);
      const path = u.pathname;
      const method = options.method || 'GET';
      
      console.log(`[MOCK] ${method} ${path}`, u.searchParams.toString());

      // Verify
      if (path === '/api/verify') {
        const token = options.headers['X-Token'];
        if (token === 'admin') return { ok: true, json: () => ({ success: true, role: 'admin' }) };
        if (token === 'write') return { ok: true, json: () => ({ success: true, role: 'write' }) };
        if (token === 'read') return { ok: true, json: () => ({ success: true, role: 'read' }) };
        return { ok: false, status: 401, json: () => ({ success: false, message: 'Invalid token' }) };
      }

      // Tree
      if (path === '/api/tree') {
        return { ok: true, json: () => Object.keys(fileSystem) };
      }

      // File Content
      if (path === '/api/file') {
        const filePath = u.searchParams.get('path');
        if (fileSystem[filePath] !== undefined) {
          return { 
            ok: true, 
            json: () => ({ 
              content: fileSystem[filePath], 
              sha: 'mock-sha-' + Date.now(), 
              size: fileSystem[filePath].length,
              name: filePath.split('/').pop()
            }) 
          };
        }
        return { ok: true, json: () => ({ error: 'File not found' }) }; // API behavior in code returns JSON with error key
      }

      // Save
      if (path === '/api/save') {
        const body = JSON.parse(options.body);
        fileSystem[body.path] = body.content;
        return { ok: true, json: () => ({ content: { sha: 'new-sha-' + Date.now() } }) };
      }

      // Delete
      if (path === '/api/delete') {
        const body = JSON.parse(options.body);
        delete fileSystem[body.path];
        return { ok: true, json: () => ({ commit: { sha: 'del-sha' } }) };
      }
      
      // Friend Links
      if (path === '/api/friend-links') {
        return { ok: true, json: () => friendLinks };
      }

      return { ok: false, status: 404, statusText: 'Not Found' };
    }
  };
})();

// Override generic fetch for API calls
const originalFetch = window.fetch;
window.fetch = async (url, options) => {
  if (typeof url === 'string' && url.startsWith('/api/')) {
    return MockBackend.fetch(url, options);
  }
  return originalFetch(url, options);
};

// ==========================================
// Application Logic
// ==========================================
const $ = id => document.getElementById(id);
const state = { 
  currentFile: null, 
  currentSha: null, 
  originalContent: '', 
  userRole: null, 
  userToken: '', 
  fileList: [], 
  isPreviewVisible: true,
  createType: 'file'
};

function toast(msg, type = 'info') {
  const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600', warning: 'bg-yellow-600' };
  const div = document.createElement('div');
  div.className = 'toast ' + colors[type] + ' text-white px-4 py-3 rounded-lg shadow-lg min-w-64';
  div.textContent = msg;
  $('toasts').appendChild(div);
  setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 300); }, 3000);
}

function getFileIcon(name) {
  const ext = name.split('.').pop().toLowerCase();
  const icons = { md: 'ğŸ“', txt: 'ğŸ“„', json: 'ğŸ“‹', js: 'ğŸŸ¨', html: 'ğŸŒ', css: 'ğŸ¨', py: 'ğŸ', yml: 'âš™ï¸', yaml: 'âš™ï¸' };
  return icons[ext] || 'ğŸ“„';
}

async function api(endpoint, options = {}) {
  const headers = { ...options.headers };
  if (state.userToken) headers['X-Token'] = state.userToken;
  return fetch(endpoint, { ...options, headers });
}

async function loadTree() {
  $('tree').innerHTML = '<div class="text-center py-8"><div class="inline-block w-6 h-6 border-2 border-slate-600 border-t-blue-500 rounded-full animate-spin"></div></div>';
  try {
    const res = await api('/api/tree');
    state.fileList = await res.json();
    renderTree(state.fileList);
  } catch (e) {
    $('tree').innerHTML = '<div class="text-center text-red-400 py-8">åŠ è½½å¤±è´¥</div>';
  }
}

function renderTree(files, filter = '') {
  const filtered = filter ? files.filter(f => f.toLowerCase().includes(filter.toLowerCase())) : files;
  if (!filtered.length) { $('tree').innerHTML = '<div class="text-center text-slate-500 py-8">æ— åŒ¹é…æ–‡ä»¶</div>'; return; }
  
  const groups = {};
  // Sort files to handle folders nicely
  filtered.sort();
  
  filtered.forEach(file => {
    const parts = file.split('/');
    const folder = parts.length > 1 ? parts.slice(0, -1).join('/') : 'æ ¹ç›®å½•';
    if (!groups[folder]) groups[folder] = [];
    groups[folder].push({ path: file, name: parts[parts.length - 1] });
  });
  
  let html = '';
  // Ensure root is first, then others alphabetically
  const folders = Object.keys(groups).sort((a, b) => {
    if (a === 'æ ¹ç›®å½•') return -1;
    if (b === 'æ ¹ç›®å½•') return 1;
    return a.localeCompare(b);
  });

  folders.forEach(folder => {
    html += '<div class="text-slate-500 text-xs px-3 py-2 mt-2 font-bold uppercase tracking-wider">' + (folder === 'æ ¹ç›®å½•' ? 'ğŸ“ æ ¹ç›®å½•' : 'ğŸ“‚ ' + folder) + '</div>';
    groups[folder].forEach(file => {
      html += '<div class="tree-item flex items-center gap-2 mx-2" data-path="' + file.path + '">' + getFileIcon(file.name) + ' <span class="truncate">' + file.name + '</span></div>';
    });
  });
  
  $('tree').innerHTML = html;
  $('tree').querySelectorAll('.tree-item').forEach(el => el.addEventListener('click', () => loadFile(el.dataset.path)));
}

async function loadFile(path) {
  $('filepath').textContent = 'åŠ è½½ä¸­...';
  try {
    // Important: encodeURIComponent handles special chars like / in query params
    const res = await api('/api/file?path=' + encodeURIComponent(path));
    const data = await res.json();
    
    if (data.error) throw new Error(data.error);
    
    state.currentFile = path;
    state.currentSha = data.sha;
    state.originalContent = data.content;
    
    $('filepath').textContent = path;
    $('editor').value = data.content;
    $('welcome').classList.add('hidden');
    $('editor').classList.remove('hidden');
    
    // Show buttons based on role
    if (state.userRole && state.userRole !== 'read') {
      $('shareBtn').classList.remove('hidden');
      $('deleteBtn').classList.remove('hidden');
    } else {
      $('shareBtn').classList.add('hidden');
      $('deleteBtn').classList.add('hidden');
    }
    
    if (path.endsWith('.md')) {
      $('previewToggle').classList.remove('hidden');
      $('preview').classList.remove('hidden');
      $('editor').classList.add('w-1/2');
      updatePreview();
    } else {
      $('previewToggle').classList.add('hidden');
      $('preview').classList.add('hidden');
      $('editor').classList.remove('w-1/2');
    }
    
    document.querySelectorAll('.tree-item').forEach(el => el.classList.toggle('active', el.dataset.path === path));
    updateSaveBtn();
  } catch (e) {
    toast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
    $('filepath').textContent = 'åŠ è½½é”™è¯¯';
  }
}

async function saveFile() {
  if (!state.currentFile || !state.userRole || state.userRole === 'read') return;
  
  $('saveBtn').disabled = true;
  $('saveBtn').textContent = 'â³ ä¿å­˜ä¸­...';
  
  try {
    const res = await api('/api/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: state.currentFile, content: $('editor').value, sha: state.currentSha })
    });
    
    if (res.status === 403) throw new Error('æ— æƒé™');
    const data = await res.json();
    
    if (data.content?.sha) {
      state.currentSha = data.content.sha;
      state.originalContent = $('editor').value;
      toast('ä¿å­˜æˆåŠŸ!', 'success');
      loadTree(); 
    } else if (data.message) {
      throw new Error(data.message);
    }
  } catch (e) {
    toast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
  } finally {
    $('saveBtn').disabled = false;
    $('saveBtn').textContent = 'ğŸ’¾ ä¿å­˜';
    updateSaveBtn();
  }
}

async function deleteFile() {
  if (!state.currentFile || !state.userRole || state.userRole === 'read') return;
  
  if (!confirm('ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ' + state.currentFile + ' å—ï¼Ÿ')) return;
  
  try {
    const res = await api('/api/delete', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: state.currentFile, sha: state.currentSha })
    });
    
    if (res.status === 403) throw new Error('æ— æƒé™');
    const data = await res.json();
    
    if (data.commit) {
      toast('åˆ é™¤æˆåŠŸ!', 'success');
      state.currentFile = null;
      state.currentSha = null;
      $('editor').classList.add('hidden');
      $('welcome').classList.remove('hidden');
      $('shareBtn').classList.add('hidden');
      $('deleteBtn').classList.add('hidden');
      $('preview').classList.add('hidden');
      loadTree();
    } else {
      throw new Error(data.message || 'åˆ é™¤å¤±è´¥');
    }
  } catch (e) {
    toast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
  }
}

function updatePreview() {
  if (state.currentFile?.endsWith('.md')) {
    $('preview').innerHTML = marked.parse($('editor').value);
    $('preview').querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
  }
}

function updateSaveBtn() {
  $('saveBtn').disabled = !state.userRole || state.userRole === 'read' || !state.currentFile;
}

function updateRoleUI() {
  const cfg = { admin: ['ğŸ‘‘ ç®¡ç†å‘˜', 'bg-purple-600'], write: ['âœï¸ ç¼–è¾‘è€…', 'bg-green-600'], read: ['ğŸ‘ï¸ åªè¯»', 'bg-blue-600'] };
  if (state.userRole && cfg[state.userRole]) {
    $('roleTag').textContent = cfg[state.userRole][0];
    $('roleTag').className = 'text-xs px-2 py-1 rounded-full ' + cfg[state.userRole][1];
    $('logoutBtn').classList.remove('hidden');
    $('createBtn').classList.remove('hidden');
  } else {
    $('roleTag').textContent = 'ğŸš¶ æ¸¸å®¢';
    $('roleTag').className = 'text-xs px-2 py-1 rounded-full bg-slate-600';
    $('createBtn').classList.add('hidden');
    $('shareBtn').classList.add('hidden');
    $('deleteBtn').classList.add('hidden');
  }
  updateSaveBtn();
}

async function verifyToken(token) {
  try {
    const res = await fetch('/api/verify', { headers: { 'X-Token': token } });
    if (res.ok) {
      const data = await res.json();
      return data.role;
    }
  } catch (e) {}
  return null;
}

async function loadFriendLinks() {
  try {
    const res = await api('/api/friend-links');
    const links = await res.json();
    if (links && links.length > 0) {
      $('friendLinks').classList.remove('hidden');
      $('friendLinksList').innerHTML = links.map(link => 
        '<a href="' + link.url + '" target="_blank" class="block text-xs text-blue-400 hover:text-blue-300 truncate transition py-1">ğŸ”— ' + link.name + '</a>'
      ).join('');
    }
  } catch (e) {
    console.error("Friend links error", e);
  }
}

function showShareModal() {
  if (!state.currentFile) return;
  
  const baseUrl = window.location.origin;
  const shareUrl = baseUrl + '/share/' + encodeURIComponent(state.currentFile);
  $('shareUrl').value = shareUrl;
  $('shareBase64').checked = false;
  $('sharePreview').classList.add('hidden');
  $('shareModal').classList.add('show');
}

$('shareBase64').addEventListener('change', () => {
  if ($('shareBase64').checked) {
    const content = $('editor').value;
    const encoded = btoa(unescape(encodeURIComponent(content)));
    $('sharePreviewContent').textContent = encoded.substring(0, 200) + (encoded.length > 200 ? '...' : '');
    $('sharePreview').classList.remove('hidden');
  } else {
    $('sharePreview').classList.add('hidden');
  }
  
  const baseUrl = window.location.origin;
  const encode = $('shareBase64').checked ? '?encode=base64' : '';
  $('shareUrl').value = baseUrl + '/share/' + encodeURIComponent(state.currentFile) + encode;
});

$('copyShareUrl').addEventListener('click', () => {
  $('shareUrl').select();
  document.execCommand('copy');
  toast('é“¾æ¥å·²å¤åˆ¶!', 'success');
});

$('shareBtn').addEventListener('click', showShareModal);
$('shareClose').addEventListener('click', () => $('shareModal').classList.remove('show'));

$('deleteBtn').addEventListener('click', deleteFile);

// è®¤è¯ç›¸å…³
$('authBtn').addEventListener('click', async () => {
  const token = $('tokenInput').value.trim();
  if (!token) { 
    $('authError').textContent = 'è¯·è¾“å…¥ Token'; 
    $('authError').classList.remove('hidden'); 
    return; 
  }
  
  const role = await verifyToken(token);
  if (role) {
    state.userToken = token;
    state.userRole = role;
    localStorage.setItem('editorToken', token);
    $('authModal').classList.remove('show');
    updateRoleUI();
    loadTree();
    loadFriendLinks();
    toast('ç™»å½•æˆåŠŸ! æƒé™: ' + role, 'success');
  } else {
    $('authError').textContent = 'Token æ— æ•ˆ (å°è¯•è¾“å…¥ admin)';
    $('authError').classList.remove('hidden');
  }
});

$('tokenInput').addEventListener('keydown', e => { 
  if (e.key === 'Enter') $('authBtn').click(); 
});

$('guestBtn').addEventListener('click', () => {
  $('authModal').classList.remove('show');
  updateRoleUI();
  loadTree();
  loadFriendLinks();
});

$('logoutBtn').addEventListener('click', () => {
  state.userRole = null;
  state.userToken = '';
  state.currentFile = null;
  state.currentSha = null;
  localStorage.removeItem('editorToken');
  
  // é‡ç½®ç•Œé¢
  $('editor').classList.add('hidden');
  $('welcome').classList.remove('hidden');
  $('shareBtn').classList.add('hidden');
  $('deleteBtn').classList.add('hidden');
  $('preview').classList.add('hidden');
  $('tokenInput').value = '';
  $('authError').classList.add('hidden');
  $('friendLinks').classList.add('hidden');
  
  // æ˜¾ç¤ºç™»å½•æ¡†
  $('authModal').classList.add('show');
  updateRoleUI();
  toast('å·²é€€å‡º', 'info');
});

// æå–æ‰€æœ‰ç›®å½•
function getDirectories() {
  const dirs = new Set(['']); // æ ¹ç›®å½•
  state.fileList.forEach(file => {
    const parts = file.split('/');
    if (parts.length > 1) {
        // For 'share/1.txt', we want 'share'
        // For 'a/b/c.txt', we want 'a/b'
        dirs.add(parts.slice(0, -1).join('/'));
    }
  });
  return Array.from(dirs).sort();
}

// æ›´æ–°ç›®å½•é€‰æ‹©å™¨
function updateDirSelect() {
  const dirs = getDirectories();
  $('createDirSelect').innerHTML = dirs.map(dir => 
    '<option value="' + dir + '">' + (dir || 'æ ¹ç›®å½•') + '</option>'
  ).join('');
}

// æ–°å»ºæ–‡ä»¶/ç›®å½•
$('createBtn').addEventListener('click', () => {
  $('createPath').value = '';
  state.createType = 'file';
  $('createTypeFile').className = 'flex-1 py-2 px-4 bg-blue-600 rounded-lg';
  $('createTypeDir').className = 'flex-1 py-2 px-4 bg-slate-600 rounded-lg';
  $('createDirSection').style.display = 'block';
  $('createPathLabel').textContent = 'æ–‡ä»¶å';
  $('createPathHint').textContent = 'è¯·è¾“å…¥æ–‡ä»¶åï¼ˆåŒ…å«æ‰©å±•åï¼‰';
  updateDirSelect();
  $('createModal').classList.add('show');
});

$('createTypeFile').addEventListener('click', () => {
  state.createType = 'file';
  $('createTypeFile').className = 'flex-1 py-2 px-4 bg-blue-600 rounded-lg';
  $('createTypeDir').className = 'flex-1 py-2 px-4 bg-slate-600 rounded-lg';
  $('createDirSection').style.display = 'block';
  $('createPathLabel').textContent = 'æ–‡ä»¶å';
  $('createPathHint').textContent = 'è¯·è¾“å…¥æ–‡ä»¶åï¼ˆåŒ…å«æ‰©å±•åï¼‰';
});

$('createTypeDir').addEventListener('click', () => {
  state.createType = 'dir';
  $('createTypeFile').className = 'flex-1 py-2 px-4 bg-slate-600 rounded-lg';
  $('createTypeDir').className = 'flex-1 py-2 px-4 bg-blue-600 rounded-lg';
  $('createDirSection').style.display = 'none';
  $('createPathLabel').textContent = 'ç›®å½•è·¯å¾„';
  $('createPathHint').textContent = 'è¯·è¾“å…¥å®Œæ•´ç›®å½•è·¯å¾„ï¼ˆå¦‚ï¼šfolder/subfolderï¼‰';
});

$('createConfirm').addEventListener('click', async () => {
  let fileName = $('createPath').value.trim();
  if (!fileName) {
    toast('è¯·è¾“å…¥' + (state.createType === 'file' ? 'æ–‡ä»¶å' : 'ç›®å½•è·¯å¾„'), 'warning');
    return;
  }
  
  let fullPath = fileName;
  
  if (state.createType === 'file') {
    // åˆ›å»ºæ–‡ä»¶
    const selectedDir = $('createDirSelect').value;
    fullPath = selectedDir ? selectedDir + '/' + fileName : fileName;
  } else {
    // åˆ›å»ºç›®å½•ï¼ˆé€šè¿‡åˆ›å»º .gitkeep æ–‡ä»¶ï¼‰
    fullPath = fileName.endsWith('/') ? fileName + '.gitkeep' : fileName + '/.gitkeep';
  }

  try {
      const res = await api('/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: fullPath, content: '', sha: null })
      });
      
      if (res.ok) {
        toast('åˆ›å»ºæˆåŠŸ!', 'success');
        $('createModal').classList.remove('show');
        await loadTree();
        // ç­‰å¾…æ–‡ä»¶æ ‘åˆ·æ–°åå†åŠ è½½æ–‡ä»¶
        setTimeout(() => loadFile(fullPath), 500);
      } else {
        const data = await res.json();
        throw new Error(data.error || 'åˆ›å»ºå¤±è´¥');
      }
  } catch (e) {
    toast('åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
  }
});

$('createCancel').addEventListener('click', () => {
  $('createModal').classList.remove('show');
});

$('search').addEventListener('input', e => renderTree(state.fileList, e.target.value));
$('editor').addEventListener('input', () => { if (state.currentFile?.endsWith('.md')) updatePreview(); });
$('saveBtn').addEventListener('click', saveFile);
$('refreshBtn').addEventListener('click', loadTree);
$('previewToggle').addEventListener('click', () => {
  state.isPreviewVisible = !state.isPreviewVisible;
  $('preview').classList.toggle('hidden', !state.isPreviewVisible);
  $('editor').classList.toggle('w-1/2', state.isPreviewVisible);
});

document.addEventListener('keydown', e => { 
  if ((e.ctrlKey || e.metaKey) && e.key === 's') { 
    e.preventDefault(); 
    if (!$('saveBtn').disabled) saveFile(); 
  } 
});

// è‡ªåŠ¨ç™»å½• (Mock token check)
const saved = localStorage.getItem('editorToken');
if (saved) {
  verifyToken(saved).then(role => {
    if (role) {
      state.userToken = saved;
      state.userRole = role;
      $('authModal').classList.remove('show');
      updateRoleUI();
      loadTree();
      loadFriendLinks();
    }
  });
}
</script>
</body>
</html>
